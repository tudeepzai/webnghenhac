<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nghe Nhạc Cùng Nhau</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .heart-beat {
            animation: heartbeat 1.5s infinite;
        }
        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        /* Custom Scrollbar for Chat */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Login/Setup Screen -->
    <div id="setup-screen" class="glass rounded-2xl p-8 w-full max-w-md shadow-2xl transition-all duration-500">
        <div class="text-center mb-8">
            <i class="fas fa-music text-5xl text-pink-600 heart-beat mb-4"></i>
            <h1 class="text-3xl font-bold text-gray-800">Couple Player</h1>
            <p class="text-gray-600 mt-2">Nghe nhạc cùng người ấy ❤️</p>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Tên của bạn</label>
                <input type="text" id="username-input" class="w-full px-4 py-2 rounded-lg border-2 border-pink-200 focus:outline-none focus:border-pink-500 bg-white/50" placeholder="Ví dụ: Anh Yêu">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Mã phòng chung</label>
                <input type="text" id="room-input" class="w-full px-4 py-2 rounded-lg border-2 border-pink-200 focus:outline-none focus:border-pink-500 bg-white/50" placeholder="Nhập mã (không dấu cách)">
                <p class="text-xs text-gray-500 mt-1">*Hai người phải nhập CÙNG mã phòng này</p>
            </div>
            <!-- Modified Button: Added ID and disabled state -->
            <button id="join-btn" onclick="joinRoom()" disabled class="w-full bg-gray-400 text-white font-bold py-3 rounded-lg transition duration-300 shadow-lg cursor-not-allowed opacity-70">
                <i class="fas fa-spinner fa-spin mr-2"></i> Đang kết nối máy chủ...
            </button>
            <div id="login-error" class="text-red-600 bg-red-100 p-2 rounded text-center text-sm hidden border border-red-300"></div>
        </div>
    </div>

    <!-- Main Player Screen (Hidden by default) -->
    <div id="player-screen" class="hidden w-full max-w-6xl h-[90vh] flex flex-col md:flex-row gap-6">
        
        <!-- Left: Player & Controls -->
        <div class="glass rounded-2xl p-6 flex-1 flex flex-col shadow-2xl relative overflow-hidden">
             <!-- Decor -->
            <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
            <div class="absolute -bottom-8 -left-8 w-40 h-40 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>

            <!-- Header -->
            <div class="flex justify-between items-center mb-4 z-10">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="font-bold text-gray-700" id="room-display">Phòng: ...</span>
                </div>
                <button onclick="leaveRoom()" class="text-gray-500 hover:text-red-500 text-sm"><i class="fas fa-sign-out-alt"></i> Thoát</button>
            </div>

            <!-- Video Container -->
            <div class="relative w-full aspect-video bg-black rounded-xl overflow-hidden shadow-lg mb-6 z-10 group">
                <div id="player-placeholder" class="absolute inset-0 flex items-center justify-center text-white text-center p-4">
                    <div>
                        <i class="fab fa-youtube text-6xl text-red-600 mb-4"></i>
                        <p>Chưa có bài hát nào.</p>
                        <p class="text-sm opacity-70">Dán link YouTube bên dưới để bắt đầu.</p>
                    </div>
                </div>
                <!-- YouTube Iframe will be injected here -->
                <div id="youtube-player" class="w-full h-full absolute inset-0"></div>
            </div>

            <!-- Controls -->
            <div class="mt-auto z-10">
                <div class="flex gap-2 mb-2">
                    <input type="text" id="video-url" class="flex-1 px-4 py-2 rounded-lg border-2 border-white/50 bg-white/50 focus:outline-none focus:border-pink-500 placeholder-gray-500" placeholder="Dán link YouTube vào đây...">
                    <button onclick="changeVideo()" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg font-bold shadow-md transition"><i class="fas fa-play"></i> Phát</button>
                </div>
                <p class="text-xs text-center text-gray-600 italic" id="status-msg">Sẵn sàng đồng bộ...</p>
            </div>
        </div>

        <!-- Right: Chat & History -->
        <div class="glass rounded-2xl p-4 w-full md:w-96 flex flex-col shadow-2xl h-full md:h-auto">
            <h3 class="font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2 flex items-center gap-2">
                <i class="fas fa-comments text-pink-500"></i> Trò chuyện
            </h3>
            
            <!-- Chat Messages -->
            <div id="chat-container" class="flex-1 overflow-y-auto scrollbar-hide space-y-3 p-2 mb-4 bg-white/30 rounded-xl">
                <!-- Messages will appear here -->
                <div class="text-center text-gray-400 text-sm mt-10">Bắt đầu trò chuyện...</div>
            </div>

            <!-- Chat Input -->
            <div class="flex gap-2">
                <input type="text" id="chat-input" class="flex-1 px-4 py-2 rounded-full border border-pink-200 bg-white focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="Nhắn gì đó...">
                <button onclick="sendMessage()" class="w-10 h-10 bg-pink-500 rounded-full text-white hover:bg-pink-600 transition flex items-center justify-center shadow-md">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white/80 z-50 hidden flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600"></div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        // --- State ---
        let currentUser = null;
        let currentRoom = null;
        let username = "";
        let player = null; 
        
        // --- Auth & Button State Handling ---
        const joinBtn = document.getElementById('join-btn');
        const errorDiv = document.getElementById('login-error');

        signInAnonymously(auth).catch((error) => {
            console.error("Auth Error:", error);
            errorDiv.textContent = "Không thể kết nối máy chủ. Vui lòng tải lại trang.";
            errorDiv.classList.remove('hidden');
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Logged in as:", user.uid);
                // Enable button when auth is ready
                joinBtn.disabled = false;
                joinBtn.innerHTML = `Bắt đầu nghe nhạc`;
                joinBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-70');
                joinBtn.classList.add('bg-pink-500', 'hover:bg-pink-600', 'transform', 'hover:-translate-y-1');
            }
        });

        // --- UI Logic ---
        window.joinRoom = async () => {
            const roomInputRaw = document.getElementById('room-input').value.trim();
            const nameInput = document.getElementById('username-input').value.trim();
            
            // Clean Room ID (remove special chars to prevent path errors)
            // Only allow letters, numbers, hyphens and underscores
            const roomInput = roomInputRaw.replace(/[^a-zA-Z0-9-_]/g, '');

            if (!roomInput || !nameInput) {
                errorDiv.innerHTML = "Vui lòng nhập tên và mã phòng.<br>Mã phòng không được chứa dấu cách/ký tự đặc biệt.";
                errorDiv.classList.remove('hidden');
                return;
            }
            if (!currentUser) {
                errorDiv.textContent = "Hệ thống chưa sẵn sàng. Đợi 1-2 giây...";
                errorDiv.classList.remove('hidden');
                return;
            }

            // Set state
            currentRoom = roomInput;
            username = nameInput;

            // Show Loading
            document.getElementById('loading').classList.remove('hidden');
            errorDiv.classList.add('hidden'); // Hide previous errors

            try {
                // Initialize Room in Firestore (public data)
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${currentRoom}`);
                
                // Check if room exists first
                const docSnap = await getDoc(roomRef);
                
                if (!docSnap.exists()) {
                    await setDoc(roomRef, {
                        currentVideoId: "",
                        status: "waiting", // playing, paused
                        updatedBy: "system",
                        messages: [{
                            sender: "System",
                            text: `Phòng ${currentRoom} được tạo.`,
                            timestamp: Date.now()
                        }]
                    });
                } else {
                     // Add join message
                     await updateDoc(roomRef, {
                        messages: arrayUnion({
                            sender: "System",
                            text: `${username} đã tham gia!`,
                            timestamp: Date.now()
                        })
                    });
                }

                // Switch UI
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('player-screen').classList.remove('hidden');
                document.getElementById('room-display').textContent = `Phòng: ${currentRoom}`;
                document.getElementById('loading').classList.add('hidden');

                // Start Listening
                listenToRoom();

            } catch (err) {
                console.error(err);
                document.getElementById('loading').classList.add('hidden');
                // Display specific error message to user
                errorDiv.textContent = `Lỗi: ${err.message || "Không thể vào phòng"}. Thử tên phòng khác đơn giản hơn (ví dụ: love123)`;
                errorDiv.classList.remove('hidden');
            }
        };

        window.leaveRoom = () => {
            location.reload();
        };

        // --- Real-time Logic ---
        function listenToRoom() {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${currentRoom}`);
            
            onSnapshot(roomRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    syncPlayer(data);
                    syncChat(data.messages);
                }
            }, (error) => {
                console.error("Sync error:", error);
            });
        }

        // --- Video Logic ---
        let lastVideoId = "";

        function syncPlayer(data) {
            const statusMsg = document.getElementById('status-msg');
            
            if (data.currentVideoId && data.currentVideoId !== lastVideoId) {
                lastVideoId = data.currentVideoId;
                updateIframe(lastVideoId);
                
                statusMsg.textContent = `${data.updatedBy} đã đổi bài hát!`;
                
                // Hide placeholder
                document.getElementById('player-placeholder').classList.add('hidden');
            }
        }

        function updateIframe(videoId) {
            const container = document.getElementById('youtube-player');
            container.innerHTML = `<iframe 
                width="100%" 
                height="100%" 
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                title="YouTube video player" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
            </iframe>`;
        }

        window.changeVideo = async () => {
            const input = document.getElementById('video-url');
            const url = input.value.trim();
            if (!url) return;

            const videoId = extractVideoID(url);
            if (!videoId) {
                alert("Link YouTube không hợp lệ!");
                return;
            }

            input.value = ""; // Clear input

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${currentRoom}`);
            await updateDoc(roomRef, {
                currentVideoId: videoId,
                updatedBy: username,
                messages: arrayUnion({
                    sender: "System",
                    text: `${username} đã bật bài hát mới.`,
                    timestamp: Date.now()
                })
            });
        };

        function extractVideoID(url) {
            var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            var match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : false;
        }

        // --- Chat Logic ---
        function syncChat(messages) {
            const chatContainer = document.getElementById('chat-container');
            if (!messages) return;

            chatContainer.innerHTML = ''; 

            messages.forEach(msg => {
                const isMe = msg.sender === username;
                const isSystem = msg.sender === "System";
                
                let html = '';
                if (isSystem) {
                    html = `<div class="text-center text-xs text-gray-500 my-2">-- ${msg.text} --</div>`;
                } else {
                    html = `
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                            <span class="text-[10px] text-gray-500 mb-1 ${isMe ? 'mr-1' : 'ml-1'}">${msg.sender}</span>
                            <div class="${isMe ? 'bg-pink-500 text-white' : 'bg-white text-gray-800 border border-gray-200'} px-3 py-2 rounded-2xl max-w-[80%] text-sm shadow-sm">
                                ${msg.text}
                            </div>
                        </div>
                    `;
                }
                chatContainer.insertAdjacentHTML('beforeend', html);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = ""; 

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${currentRoom}`);
            await updateDoc(roomRef, {
                messages: arrayUnion({
                    sender: username,
                    text: text,
                    timestamp: Date.now()
                })
            });
        };

        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

    </script>
</body>
</html>
